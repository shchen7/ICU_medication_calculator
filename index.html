<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ICU 急救藥物速率計算器</title>
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#0f172a" />
  <style>
    body{font-family:system-ui,sans-serif;background:#f8fafc;color:#0f172a;margin:0}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 4px 16px rgba(0,0,0,.06)}
    .input,.select,textarea{border:1px solid #cbd5e1;border-radius:10px;padding:8px 10px;font-size:14px}
    .note{font-size:14px;color:#0f172a}
    .hint{font-size:12px;color:#64748b}
    .btn{border:1px solid #0f172a;border-radius:10px;padding:6px 10px;background:#0f172a;color:#fff;font-size:12px;cursor:pointer}
    .btn-ghost{border:1px solid #cbd5e1;border-radius:10px;padding:6px 10px;background:#fff;color:#0f172a;cursor:pointer}
    .pill{border:1px solid #e5e7eb;border-radius:999px;padding:4px 10px;font-size:12px;background:#f1f5f9}
    h3{margin:0 0 6px 0}
    b{font-size:16px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
    .modal.open{display:flex}
    .panel{width:min(1000px,100%);max-height:90vh;overflow:auto;background:#fff;border-radius:16px;padding:16px;border:1px solid #e5e7eb}
    .hr{height:1px;background:#e5e7eb;margin:12px 0}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>ICU 急救藥物速率計算器</h1>
        <div class="note">建議劑量＋即時換算 mL/hr · 濃度可切換 · 可視化管理 · 顯示可用溶液（NS/D5W）</div>
      </div>
      <div class="row">
        <button id="manage" class="btn-ghost">管理</button>
        <button id="refresh" class="btn">🔄 強制刷新</button>
      </div>
    </div>

    <div id="cards"></div>
    <div class="card"><div class="hint">臨床安全提醒：本工具僅供提醒；最終仍以院內處方集 / 醫囑 / SOP 為準。</div></div>
  </div>

  <!-- 管理面板 -->
  <div id="modal" class="modal">
    <div class="panel">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">藥物清單管理</h3>
        <div class="row">
          <button id="export" class="btn-ghost">匯出</button>
          <button id="import" class="btn-ghost">匯入</button>
          <button id="close" class="btn">關閉</button>
        </div>
      </div>
      <div class="hint">資料儲存在此裝置（localStorage: <code>icu-drugs-v7</code>）。</div>
      <div id="list" style="margin-top:10px"></div>
      <div class="hr"></div>
      <button id="add" class="btn">＋ 新增藥物</button>
    </div>
  </div>

  <script>
  // ===== 資料 =====
  const KEY = 'icu-drugs-v7';

  // 說明：
  // unit: 'ug' = 微克; 'mg' = 毫克; 'unit' = U（生物單位）
  // concs[].value 的單位要與 unit 對應（ug/mL, mg/mL, U/mL）
  // ref.unit 只用來顯示（不改變計算），計算依據 unit 與 type
  // diluents: 可用溶媒陣列，支援 'NS' / 'D5W'（可在管理面板勾選）
  const DEFAULT = [
    // 1) Norepinephrine (Levophed) — 非體重型，2–30 μg/min
    { key:"NE", name:"Norepinephrine (Levophed) 正腎上腺素", unit:"ug",
      concs:[
        {label:"8 mg / 250 mL (32 μg/mL)", value:32},
        {label:"16 mg / 250 mL (64 μg/mL)", value:64}
      ],
      ref:{min:2, max:30, unit:"μg/min", type:"nonwt"},
      diluents:["NS","D5W"],
      notes:"建議 CVC；周邊僅暫用並嚴密監測外滲。"
    },

    // 2) Vasopressin (Pitressin) — 非體重型
    { key:"Vaso", name:"Vasopressin (Pitressin) 加壓素", unit:"unit",
      concs:[{label:"40 U / 100 mL (0.4 U/mL)", value:0.4}],
      ref:{min:0.01, max:0.04, unit:"U/min", type:"nonwt"},
      diluents:["NS","D5W"],
      notes:"常固定 0.03–0.04 U/min 作為 NE 佐藥；不建議再上調。"
    },

    // 3) Epinephrine (Adrenalin) — 非體重型
    { key:"Epi", name:"Epinephrine (Adrenalin) 腎上腺素", unit:"ug",
      concs:[
        {label:"1 mg / 100 mL (10 μg/mL)", value:10},
        {label:"5 mg / 250 mL (20 μg/mL)", value:20}
      ],
      ref:{min:2, max:10, unit:"μg/min", type:"nonwt"},
      diluents:["NS","D5W"],
      notes:"依反應滴定；周邊僅暫用，優先 CVC。"
    },

    // 4) Dopamine (Gipamine) — 體重型，院內 600 mg / 200 mL = 3000 μg/mL
    { key:"Dopa", name:"Dopamine (Gipamine) 多巴胺", unit:"ug",
      concs:[{label:"600 mg / 200 mL (3000 μg/mL)", value:3000}],
      ref:{min:5, max:20, unit:"μg/kg/min", type:"wt"},
      diluents:["NS","D5W"],
      notes:"5–10 μg/kg/min 以 β 效應為主；10–20 μg/kg/min α 效應↑。"
    },

    // 5) Dobutamine (GENDOBU) — 體重型
    { key:"Dobu", name:"Dobutamine (GENDOBU) 多巴酚丁胺", unit:"ug",
      concs:[
        {label:"250 mg / 250 mL (1000 μg/mL)", value:1000},
        {label:"500 mg / 250 mL (2000 μg/mL)", value:2000}
      ],
      ref:{min:2, max:20, unit:"μg/kg/min", type:"wt"},
      diluents:["NS","D5W"],
      notes:"2–20 μg/kg/min 常用；留意心搏過速與血壓。"
    },

    // 6) Lidocaine (Xylocaine) — 非體重型（原建議用 mg/min；濃度用 mg/mL）
    { key:"Lido", name:"Lidocaine (Xylocaine) 利多卡因", unit:"mg",
      concs:[
        {label:"1 g / 500 mL (2 mg/mL)", value:2},
        {label:"2 g / 500 mL (4 mg/mL)", value:4}
      ],
      ref:{min:1, max:4, unit:"mg/min", type:"nonwt"},
      diluents:["NS","D5W"],
      notes:"抗心律不整維持 1–4 mg/min；肝腎功能不全酌降。"
    },

    // 7) Nicardipine (Perdipine) — 非體重型（你指定：5 amp in 200 mL；加入袋內總量 → 50 mg / 250 mL = 0.2 mg/mL）
    { key:"Nica", name:"Nicardipine (Perdipine) 尼卡地平", unit:"mg",
      concs:[
        {label:"5 amp in 200 mL → 50 mg / 250 mL (0.2 mg/mL)", value:0.2}
      ],
      ref:{min:5, max:15, unit:"mg/hr", type:"nonwt"},
      diluents:["NS","D5W"],
      notes:"5 mg/hr 起，每 5–15 分鐘加 2.5 mg/hr，最大 15 mg/hr。"
    },

    // 8) Nitroglycerin (Millistrol) — 非體重型（加入袋內總量）
    // 5 amp in 200 mL：總量 250 mL → 1000 μg/mL
    // 10 amp in 150 mL：總量 250 mL → 2000 μg/mL
    { key:"NTG", name:"Nitroglycerin (Millistrol) 硝酸甘油", unit:"ug",
      concs:[
        {label:"5 amp in 200 mL → 250 mg / 250 mL (1000 μg/mL)", value:1000},
        {label:"10 amp in 150 mL → 500 mg / 250 mL (2000 μg/mL)", value:2000}
      ],
      ref:{min:5, max:200, unit:"μg/min", type:"nonwt"},
      diluents:["NS","D5W"],
      notes:"起始 5 μg/min 逐步上調；使用玻璃瓶/非吸附管路。"
    },
  ];

  const $ = s => document.querySelector(s);
  const fmt = n => Number.isFinite(n)?(+n).toFixed(2).replace(/\.?0+$/,''):"";
  let model = load(); render();

  function load(){ try{ const x = JSON.parse(localStorage.getItem(KEY)); return Array.isArray(x)&&x.length?x:DEFAULT; } catch{ return DEFAULT } }
  function save(){ localStorage.setItem(KEY, JSON.stringify(model)); }

  // ===== 計算 =====
  function baseUnitSymbol(drug){
    if (drug.unit==='ug') return 'μg';
    if (drug.unit==='mg') return 'mg';
    if (drug.unit==='unit') return 'U';
    return '';
  }
  function doseUnitPerMin(drug, byWeight){
    const b = baseUnitSymbol(drug);
    return byWeight ? `${b}/kg/min` : `${b}/min`;
  }
  function concUnitPerMl(drug){
    const b = baseUnitSymbol(drug);
    return `${b}/mL`;
  }
  function suggestRateText(d, conc, wt){
    if (!conc) return "";
    const {min, max, type} = d.ref;
    if (type==='wt'){
      if (!(wt>0)) return "請先輸入體重";
      const rMin=min*wt*60/conc, rMax=max*wt*60/conc;
      return `${fmt(rMin)}–${fmt(rMax)} mL/hr`;
    } else {
      const rMin=min*60/conc, rMax=max*60/conc;
      return `${fmt(rMin)}–${fmt(rMax)} mL/hr`;
    }
  }

  // ===== UI：藥卡 =====
  function makeCard(d){
    const card = document.createElement('div'); card.className='card';
    const title = document.createElement('h3'); title.textContent = d.name; card.appendChild(title);

    // 可用溶媒顯示
    const dil = document.createElement('div'); dil.className='chips';
    const label = document.createElement('div'); label.className='hint'; label.textContent = '可用溶媒：';
    dil.appendChild(label);
    (d.diluents||[]).forEach(x=>{
      const t=document.createElement('span'); t.className='pill'; t.textContent=x; dil.appendChild(t);
    });
    card.appendChild(dil);

    // 建議劑量（保留原始單位）
    const suggest = document.createElement('div');
    suggest.innerHTML = `<b>建議劑量：</b>${d.ref.min}–${d.ref.max} ${d.ref.unit}（成人）`;
    card.appendChild(suggest);

    // 濃度選擇
    const sel = document.createElement('select'); sel.className='select';
    d.concs.forEach(c=>{ const o=document.createElement('option'); o.value=c.value; o.textContent=c.label; sel.appendChild(o); });
    card.append("濃度：", sel);

    // 建議速率（同步）
    const sugg = document.createElement('div'); sugg.className='note'; card.appendChild(sugg);

    // 計算區
    const box = document.createElement('div'); box.className='card'; box.style.padding='12px'; box.style.marginTop='10px';

    if (d.ref.type === 'wt'){
      // 體重型：體重 + (單位/kg/min) → mL/hr
      const wRow = document.createElement('div'); wRow.className='row';
      const wLab = document.createElement('span'); wLab.textContent='體重';
      const wInp = document.createElement('input'); wInp.className='input'; wInp.style.width='90px'; wInp.placeholder='60'; wInp.inputMode='decimal';
      const wUnit = document.createElement('span'); wUnit.textContent='kg';
      wRow.append(wLab, wInp, wUnit);
      box.appendChild(wRow);

      const doseRow = document.createElement('div'); doseRow.className='row';
      const dInp = document.createElement('input'); dInp.className='input'; dInp.placeholder=`${d.ref.min}–${d.ref.max}`; dInp.inputMode='decimal';
      const dUnit = document.createElement('span'); dUnit.textContent=doseUnitPerMin(d, true);
      const out = document.createElement('div'); out.className='note'; out.textContent='＝';
      const formula = document.createElement('div'); formula.className='hint';
      formula.textContent = `${doseUnitPerMin(d,true)} × 體重(kg) × 60 ÷ 濃度(${concUnitPerMl(d)}) = mL/hr`;
      doseRow.append(dInp, dUnit, out);
      box.appendChild(doseRow);
      box.appendChild(formula);

      const update = ()=>{
        const conc = parseFloat(sel.value);
        const wt = parseFloat(wInp.value)||0;
        sugg.textContent = `≈ 建議速率：${suggestRateText(d, conc, wt)}`;
        const dose = parseFloat(dInp.value);
        if (Number.isFinite(dose) && conc>0 && wt>0){
          out.textContent = `＝ ${fmt(dose*wt*60/conc)} mL/hr`;
        } else {
          out.textContent = wt>0? '＝' : '＝ 請先輸入體重';
        }
      };
      [sel,wInp,dInp].forEach(x=>x.addEventListener('input', update));
      update();
    } else {
      // 非體重型：(單位/min) → mL/hr
      const conc = ()=>parseFloat(sel.value);
      const doseRow = document.createElement('div'); doseRow.className='row';
      const dInp = document.createElement('input'); dInp.className='input'; dInp.placeholder=`${d.ref.min}–${d.ref.max}`; dInp.inputMode='decimal';
      const dUnit = document.createElement('span'); dUnit.textContent=doseUnitPerMin(d, false);
      const out = document.createElement('div'); out.className='note'; out.textContent='＝';
      const formula = document.createElement('div'); formula.className='hint';
      formula.textContent = `${doseUnitPerMin(d,false)} × 60 ÷ 濃度(${concUnitPerMl(d)}) = mL/hr`;
      doseRow.append(dInp, dUnit, out);
      box.appendChild(doseRow);
      box.appendChild(formula);

      const update = ()=>{
        sugg.textContent = `≈ 建議速率：${suggestRateText(d, conc(), 0)}`;
        const dose = parseFloat(dInp.value);
        if (Number.isFinite(dose) && conc()>0){
          out.textContent = `＝ ${fmt(dose*60/conc())} mL/hr`;
        } else { out.textContent = '＝'; }
      };
      [sel,dInp].forEach(x=>x.addEventListener('input', update));
      update();
    }

    card.appendChild(box);

    // 備註
    const note = document.createElement('div'); note.className='hint'; note.textContent = d.notes || '';
    card.appendChild(note);

    return card;
  }

  function render(){
    const box = $('#cards'); box.innerHTML='';
    model.forEach(d => box.appendChild(makeCard(d)));
  }

  // ===== 管理面板（表單化，含溶媒勾選） =====
  function openManage(){ $('#modal').classList.add('open'); renderList(); }
  function closeManage(){ $('#modal').classList.remove('open'); }

  function renderList(){
    const L = $('#list'); L.innerHTML='';
    model.forEach((d,i)=>{
      const row = document.createElement('div'); row.className='card';
      row.innerHTML = `<b>${d.name}</b> <span class="hint">(${d.key})</span><br>
        <span class="hint">濃度：${d.concs.map(x=>x.label).join('、')}</span><br>
        <span class="hint">可用溶液：${(d.diluents||[]).join('、')||'—'}</span>`;
      const btnE = document.createElement('button'); btnE.className='btn-ghost'; btnE.textContent='編輯';
      const btnD = document.createElement('button'); btnD.className='btn-ghost'; btnD.textContent='刪除';
      btnE.onclick=()=>editDrug(i);
      btnD.onclick=()=>{ if(confirm('確定刪除？')){ model.splice(i,1); save(); renderList(); render(); } };
      row.append(document.createElement('br'), btnE, btnD);
      L.appendChild(row);
    });
  }

  function field(label, el){
    const wrap = document.createElement('label'); wrap.style.display='block'; wrap.style.margin='6px 0';
    const cap = document.createElement('div'); cap.className='hint'; cap.textContent = label;
    wrap.append(cap, el); return wrap;
  }

  function editDrug(i){
    const d = JSON.parse(JSON.stringify(model[i])); // clone
    const box = $('#list'); box.innerHTML='';

    const key = document.createElement('input'); key.className='input'; key.value=d.key;
    const name = document.createElement('input'); name.className='input'; name.value=d.name;

    const unit = document.createElement('select'); unit.className='select';
    [['ug','微克 μg'],['mg','毫克 mg'],['unit','單位 U']].forEach(([v,t])=>{ const o=document.createElement('option'); o.value=v; o.textContent=t; unit.appendChild(o); });
    unit.value = d.unit;

    const type = document.createElement('select'); type.className='select';
    [['wt','體重型（*/kg/min）'],['nonwt','非體重型（*/min）']].forEach(([v,t])=>{ const o=document.createElement('option'); o.value=v; o.textContent=t; type.appendChild(o); });
    type.value = d.ref.type;

    const rmin = document.createElement('input'); rmin.className='input'; rmin.inputMode='decimal'; rmin.value=d.ref.min;
    const rmax = document.createElement('input'); rmax.className='input'; rmax.inputMode='decimal'; rmax.value=d.ref.max;
    const runit = document.createElement('input'); runit.className='input'; runit.value=d.ref.unit;

    const notes = document.createElement('textarea'); notes.className='input'; notes.value=d.notes||''; notes.rows=3;

    // 溶媒勾選
    const dilWrap = document.createElement('div');
    const cbNS = document.createElement('input'); cbNS.type='checkbox';
    const labNS = document.createElement('span'); labNS.textContent='NS';
    const cbD5 = document.createElement('input'); cbD5.type='checkbox';
    const labD5 = document.createElement('span'); labD5.textContent='D5W';
    cbNS.checked = (d.diluents||[]).includes('NS');
    cbD5.checked = (d.diluents||[]).includes('D5W');
    const dilRow = document.createElement('div'); dilRow.className='row';
    dilRow.append(cbNS, labNS, cbD5, labD5);
    dilWrap.appendChild(dilRow);

    // 濃度清單
    const concWrap = document.createElement('div');
    const concList = document.createElement('div'); concWrap.appendChild(concList);
    const addConcBtn = document.createElement('button'); addConcBtn.className='btn-ghost'; addConcBtn.textContent='＋ 新增濃度';
    addConcBtn.onclick = ()=>{ d.concs.push({label:'',value:0}); drawConcs(); };
    concWrap.appendChild(addConcBtn);

    function drawConcs(){
      concList.innerHTML='';
      d.concs.forEach((c,ci)=>{
        const row=document.createElement('div'); row.className='row';
        const l=document.createElement('input'); l.className='input'; l.style.flex='1'; l.placeholder='例：50 mg / 250 mL (0.2 mg/mL)'; l.value=c.label;
        const v=document.createElement('input'); v.className='input'; v.style.width='160px'; v.inputMode='decimal'; v.placeholder='數值(與單位一致，例如 0.2、1000)'; v.value=c.value;
        const del=document.createElement('button'); del.className='btn-ghost'; del.textContent='刪除';
        l.oninput=()=>c.label=l.value; v.oninput=()=>c.value=+v.value; del.onclick=()=>{ d.concs.splice(ci,1); drawConcs(); };
        row.append(l,v,del); concList.appendChild(row);
      });
    }
    drawConcs();

    const saveBtn = document.createElement('button'); saveBtn.className='btn'; saveBtn.textContent='儲存';
    saveBtn.onclick = ()=>{
      d.key = key.value.trim(); d.name = name.value.trim();
      d.unit = unit.value; d.ref.type = type.value;
      d.ref.min = +rmin.value; d.ref.max = +rmax.value; d.ref.unit = runit.value.trim();
      d.diluents = []; if (cbNS.checked) d.diluents.push('NS'); if (cbD5.checked) d.diluents.push('D5W');
      d.concs = d.concs.filter(x=>x.label && Number.isFinite(+x.value) && +x.value>0).map(x=>({label:x.label, value:+x.value}));
      d.notes = notes.value;
      if (!d.key || !d.name) return alert('key 與 name 必填');
      if (d.concs.length===0) return alert('至少一筆濃度');
      model[i] = d; save(); renderList(); render(); alert('已儲存');
    };

    const backBtn = document.createElement('button'); backBtn.className='btn-ghost'; backBtn.textContent='返回';
    backBtn.onclick = ()=> renderList();

    box.append(
      field('key（英數，不重複）', key),
      field('名稱', name),
      field('單位（μg / mg / U）', unit),
      field('劑量型態（體重型 / 非體重型）', type),
      field('建議劑量最小值（與顯示單位對應）', rmin),
      field('建議劑量最大值（與顯示單位對應）', rmax),
      field('建議劑量顯示單位（例：μg/min、μg/kg/min、mg/hr、U/min）', runit),
      field('可用溶液（勾選）', dilWrap),
      field('濃度清單（value 請用與單位相同的單位 / mL）', concWrap),
      field('備註', notes),
      document.createElement('div'),
      saveBtn, backBtn
    );
  }

  function addDrug(){
    model.push({
      key:'Drug'+(Date.now()%10000), name:'新藥', unit:'ug',
      concs:[{label:'1 mg / 100 mL (10 μg/mL)', value:10}],
      ref:{min:1, max:10, unit:'μg/kg/min', type:'wt'},
      diluents:['NS','D5W'],
      notes:''
    });
    save(); renderList();
  }

  // 管理面板事件
  $('#manage').onclick = openManage;
  $('#close').onclick = closeManage;
  $('#add').onclick = addDrug;

  // 匯出 / 匯入
  $('#export').onclick = ()=>{
    const blob = new Blob([JSON.stringify(model,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='icu-drugs-export.json'; a.click();
    URL.revokeObjectURL(url);
  };
  $('#import').onclick = ()=>{
    const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange = ()=>{ const f=inp.files[0]; if(!f) return;
      f.text().then(t=>{
        try{ const arr=JSON.parse(t); if(!Array.isArray(arr)) throw 0; model=arr; save(); renderList(); render(); alert('匯入完成'); }
        catch{ alert('格式錯誤：需要 Array JSON'); }
      });
    };
    inp.click();
  };

  // 初次渲染
  function renderList(){ /* 定義於上方，避免未定義錯誤 */ }
  renderList = function(){
    const L = $('#list'); L.innerHTML='';
    model.forEach((d,i)=>{
      const row = document.createElement('div'); row.className='card';
      row.innerHTML = `<b>${d.name}</b> <span class="hint">(${d.key})</span><br>
        <span class="hint">濃度：${d.concs.map(x=>x.label).join('、')}</span><br>
        <span class="hint">可用溶液：${(d.diluents||[]).join('、')||'—'}</span>`;
      const btnE = document.createElement('button'); btnE.className='btn-ghost'; btnE.textContent='編輯';
      const btnD = document.createElement('button'); btnD.className='btn-ghost'; btnD.textContent='刪除';
      btnE.onclick=()=>editDrug(i); btnD.onclick=()=>{ if(confirm('確定刪除？')){ model.splice(i,1); save(); renderList(); render(); } };
      row.append(document.createElement('br'), btnE, btnD);
      L.appendChild(row);
    });
  };

  // === 渲染藥卡 ===
  function render(){ const box = $('#cards'); box.innerHTML=''; model.forEach(d => box.appendChild(makeCard(d))); }

  // PWA Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }

  // 🔄 強制刷新
  $('#refresh').addEventListener('click', async ()=>{
    try{
      if ('caches' in window){ const keys = await caches.keys(); for (let k of keys) await caches.delete(k); }
      if (navigator.serviceWorker){ const regs = await navigator.serviceWorker.getRegistrations(); for (let r of regs) await r.unregister(); }
    } finally { location.reload(true); }
  });
  </script>
</body>
</html>



