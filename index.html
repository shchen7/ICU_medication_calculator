<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ICU æ€¥æ•‘è—¥ç‰©é€Ÿç‡è¨ˆç®—å™¨</title>
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#0f172a" />
  <style>
    body{font-family:system-ui,sans-serif;background:#f8fafc;color:#0f172a;margin:0}
    .wrap{max-width:1000px;margin:24px auto;padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 4px 16px rgba(0,0,0,.06)}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .input,.select{border:1px solid #cbd5e1;border-radius:10px;padding:8px 10px;font-size:14px}
    .note{font-size:14px;color:#0f172a}
    .hint{font-size:12px;color:#64748b}
    .btn{border:1px solid #0f172a;border-radius:10px;padding:6px 10px;background:#0f172a;color:#fff;font-size:12px;cursor:pointer}
    .col{display:flex;flex-direction:column;gap:6px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:800px){ .grid{grid-template-columns:1fr 1fr} }
    h3{margin:0 0 6px 0}
    b{font-size:16px}
    .muted{opacity:.6}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>ICU æ€¥æ•‘è—¥ç‰©é€Ÿç‡è¨ˆç®—å™¨</h1>
        <div class="note">PWA Â· å»ºè­°åŠ‘é‡ï¼‹å³æ™‚æ›ç®— mL/hr Â· æ¿ƒåº¦å¯åˆ‡æ›</div>
      </div>
      <div class="row">
        <span>é«”é‡</span>
        <input id="weight" class="input" style="width:90px" inputmode="decimal" placeholder="60">
        <span>kg</span>
        <button id="refresh" class="btn">ğŸ”„ å¼·åˆ¶åˆ·æ–°</button>
      </div>
    </div>
    <div id="cards"></div>
  </div>

  <script>
  // ---- è—¥ç‰©è³‡æ–™ï¼ˆè‡¨åºŠå»ºè­°åŠ‘é‡ + å¯é¸æ¿ƒåº¦ï¼‰ ----
  const DRUGS = [
    { key:"Epi", name:"Epinephrine è…ä¸Šè…ºç´ ", unit:"ug",
      concs:[{label:"1 mg / 100 mL (10 Î¼g/mL)",value:10},{label:"5 mg / 250 mL (20 Î¼g/mL)",value:20}],
      ref:{min:2, max:10, unit:"Î¼g/min", type:"nonwt"},
      notes:"ACLS/ä¼‘å…‹æ”¯æ´ï¼›å‘¨é‚Šåƒ…æš«ç”¨ï¼Œå„ªå…ˆ CVCã€‚"
    },
    { key:"NE", name:"Norepinephrine (Levophed) æ­£è…ä¸Šè…ºç´ ", unit:"ug",
      concs:[{label:"8 mg / 250 mL (32 Î¼g/mL)",value:32},{label:"16 mg / 250 mL (64 Î¼g/mL)",value:64}],
      ref:{min:2, max:30, unit:"Î¼g/min", type:"nonwt"},
      notes:"æ•—è¡€æ€§ä¼‘å…‹é¦–é¸ï¼›åš´é˜²å¤–æ»²ï¼Œæœ«æ¢¢ç›£æ¸¬ã€‚"
    },
    { key:"Dopa", name:"Dopamine å¤šå·´èƒº", unit:"ug",
      // é™¢å…§é…æ³•ï¼š600 mg / 200 mL = 3000 Î¼g/mL
      concs:[{label:"600 mg / 200 mL (3000 Î¼g/mL)",value:3000}],
      ref:{min:5, max:20, unit:"Î¼g/kg/min", type:"wt"},
      notes:"ä¸­é«˜åŠ‘é‡å…·æœ‰ Î± æ•ˆæ‡‰ï¼Œéœ€ç›£æ§ã€‚"
    },
    { key:"Dobu", name:"Dobutamine å¤šå·´é…šä¸èƒº", unit:"ug",
      concs:[{label:"250 mg / 250 mL (1000 Î¼g/mL)",value:1000}],
      ref:{min:2, max:20, unit:"Î¼g/kg/min", type:"wt"},
      notes:"ä½å¿ƒè¼¸å‡ºæ€§å¿ƒè¡°ç”¨è—¥ã€‚"
    },
    { key:"Vaso", name:"Vasopressin åŠ å£“ç´ ", unit:"unit",
      concs:[{label:"40 U / 100 mL (0.4 U/mL)",value:0.4}],
      ref:{min:0.01, max:0.04, unit:"U/min", type:"nonwt"},
      notes:"å¤šæ¡å›ºå®šåŠ‘é‡ï¼›ä¸å»ºè­°æ»´å®š >0.04 U/minã€‚"
    }
  ];

  const $ = s => document.querySelector(s);
  const fmt = n => Number.isFinite(n)?(+n).toFixed(2).replace(/\.?0+$/,''):"";

  // å»ºè­°é€Ÿç‡ç¯„åœ (mL/hr) from å»ºè­°åŠ‘é‡ç¯„åœ
  function calcSuggestRange(drug, conc, wt){
    if (!conc) return "";
    const {min, max, type} = drug.ref;
    if (type === "wt"){
      if (!(wt>0)) return "è«‹å…ˆè¼¸å…¥é«”é‡";
      const rMin = min*wt*60/conc, rMax = max*wt*60/conc;
      return `${fmt(rMin)}â€“${fmt(rMax)} mL/hr`;
    } else {
      const rMin = min*60/conc, rMax = max*60/conc;
      return `${fmt(rMin)}â€“${fmt(rMax)} mL/hr`;
    }
  }

  function makeCard(d){
    const card = document.createElement("div"); card.className = "card";
    const title = document.createElement("h3"); title.textContent = d.name; card.appendChild(title);

    // å»ºè­°åŠ‘é‡
    const suggest = document.createElement("div");
    suggest.innerHTML = `<b>å»ºè­°åŠ‘é‡ï¼š</b>${d.ref.min}â€“${d.ref.max} ${d.ref.unit}ï¼ˆæˆäººï¼‰`;
    card.appendChild(suggest);

    // æ¿ƒåº¦ä¸‹æ‹‰
    const sel = document.createElement("select"); sel.className = "select";
    d.concs.forEach(c => { const o=document.createElement("option"); o.value=c.value; o.textContent=c.label; sel.appendChild(o); });
    card.append("æ¿ƒåº¦ï¼š", sel);

    // å»ºè­°é€Ÿç‡ï¼ˆåŒæ­¥ï¼‰
    const suggRate = document.createElement("div"); suggRate.className = "note";
    card.appendChild(suggRate);

    // å…©ç¨®å³æ™‚æ›ç®—ï¼ˆè¼¸å…¥åŠ‘é‡ â†’ é€Ÿç‡ï¼‰
    const grid = document.createElement("div"); grid.className = "grid"; card.appendChild(grid);

    // é«”é‡å‹è¼¸å…¥
    const colW = document.createElement("div"); colW.className = "col";
    const wLabel = document.createElement("div"); wLabel.innerHTML = `<b>æŒ‰é«”é‡åŠ‘é‡ â†’ é€Ÿç‡</b>`;
    const inpW = document.createElement("input"); inpW.className="input"; inpW.placeholder = d.ref.type==='wt' ? `${d.ref.min}â€“${d.ref.max}` : "";
    inpW.inputMode = "decimal";
    const outW = document.createElement("div"); outW.className="note";
    const formulaW = document.createElement("div"); formulaW.className="hint";
    colW.append(wLabel, inpW, outW, formulaW);

    // éé«”é‡è¼¸å…¥
    const colN = document.createElement("div"); colN.className = "col";
    const nLabel = document.createElement("div"); nLabel.innerHTML = `<b>éé«”é‡åŠ‘é‡ â†’ é€Ÿç‡</b>`;
    const inpN = document.createElement("input"); inpN.className="input"; inpN.placeholder = d.ref.type==='nonwt' ? `${d.ref.min}â€“${d.ref.max}` : "";
    inpN.inputMode = "decimal";
    const outN = document.createElement("div"); outN.className="note";
    const formulaN = document.createElement("div"); formulaN.className="hint";
    colN.append(nLabel, inpN, outN, formulaN);

    grid.append(colW, colN);

    // å‚™è¨»
    const note = document.createElement("div"); note.className="hint"; note.textContent = d.notes; card.appendChild(note);

    // è¨ˆç®—å‡½å¼ï¼ˆå³æ™‚ï¼‰
    const updateAll = () => {
      const conc = parseFloat(sel.value);
      const wt = parseFloat($("#weight").value) || 0;

      // å»ºè­°é€Ÿç‡ç¯„åœï¼ˆé«”é‡å‹æ²’å¡«é«”é‡å°±æ˜ç¢ºæç¤ºï¼‰
      const r = calcSuggestRange(d, conc, wt);
      suggRate.textContent = `â‰ˆ å»ºè­°é€Ÿç‡ï¼š${r}`;

      // è·¯å¾‘ä¸€ï¼šé«”é‡ï¼ˆÎ¼g/kg/min æˆ– U/kg/minï¼‰
      const doseW = parseFloat(inpW.value);
      if (Number.isFinite(doseW) && conc>0 && wt>0) {
        const rateW = (doseW * wt * 60) / conc;
        outW.textContent = `ï¼ ${fmt(rateW)} mL/hr`;
      } else {
        outW.textContent = d.ref.type==='wt' && !(wt>0) ? "ï¼ è«‹å…ˆè¼¸å…¥é«”é‡" : "ï¼";
      }
      const unitW = (d.unit === 'ug') ? 'Î¼g/kg/min' : 'U/kg/min';
      formulaW.textContent = `${unitW} Ã— é«”é‡(kg) Ã— 60 Ã· æ¿ƒåº¦(${d.unit==='ug'?'Î¼g/mL':'U/mL'}) = mL/hr`;

      // è·¯å¾‘äºŒï¼šéé«”é‡ï¼ˆÎ¼g/min æˆ– U/minï¼‰
      const doseN = parseFloat(inpN.value);
      if (Number.isFinite(doseN) && conc>0) {
        const rateN = (doseN * 60) / conc;
        outN.textContent = `ï¼ ${fmt(rateN)} mL/hr`;
      } else {
        outN.textContent = "ï¼";
      }
      const unitN = (d.unit === 'ug') ? 'Î¼g/min' : 'U/min';
      formulaN.textContent = `${unitN} Ã— 60 Ã· æ¿ƒåº¦(${d.unit==='ug'?'Î¼g/mL':'U/mL'}) = mL/hr`;

      // è¦–è¦ºæç¤ºï¼šå¦‚æœæ­¤è—¥æ˜¯é«”é‡å‹ï¼Œå°‡éé«”é‡æ¬„ä½æ·¡åŒ–ï¼›åä¹‹äº¦ç„¶ï¼ˆé¿å…èª¤ç”¨ï¼‰
      colN.classList.toggle('muted', d.ref.type==='wt');
      colW.classList.toggle('muted', d.ref.type==='nonwt');
    };

    sel.addEventListener('change', updateAll);
    $("#weight").addEventListener('input', updateAll);
    inpW.addEventListener('input', updateAll);
    inpN.addEventListener('input', updateAll);

    updateAll();
    return card;
  }

  function render(){
    const box = $("#cards"); box.innerHTML = "";
    DRUGS.forEach(d => box.appendChild(makeCard(d)));
  }

  render();

  // PWA è¨»å†Š
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }

  // ğŸ”„ å¼·åˆ¶åˆ·æ–°ï¼šæ¸…é™¤ caches + è§£é™¤è¨»å†Š SW + é‡æ–°è¼‰å…¥
  document.getElementById('refresh').addEventListener('click', async () => {
    try{
      if ('caches' in window) {
        const keys = await caches.keys();
        for (let k of keys) await caches.delete(k);
      }
      if (navigator.serviceWorker) {
        const regs = await navigator.serviceWorker.getRegistrations();
        for (let r of regs) await r.unregister();
      }
    } finally {
      location.reload(true);
    }
  });
  </script>
</body>
</html>

