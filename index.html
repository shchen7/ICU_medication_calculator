<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ICUè—¥ç‰©é€Ÿç‡è¨ˆç®—å™¨</title>
  <!-- PWA -->
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#0f172a" />
  <style>
    /* ===== ä¸»é¡Œè®Šæ•¸ï¼ˆæ”¯æ´æ·º/æ·±è‰²ï¼‰ ===== */
    :root{
      --bg:#f8fafc; --text:#0f172a; --card:#ffffff; --border:#e5e7eb;
      --muted:#64748b; --accent:#0f172a; --pill:#f1f5f9;
    }

    body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);margin:0}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 4px 16px rgba(0,0,0,.06)}
    .input,.select,textarea{border:1px solid #cbd5e1;border-radius:10px;padding:8px 10px;font-size:14px}
    .note{font-size:14px;color:var(--text)}
    .hint{font-size:12px;color:var(--muted)}
    .btn{border:1px solid var(--accent);border-radius:10px;padding:6px 10px;background:var(--accent);color:#fff;font-size:12px;cursor:pointer}
    .btn-ghost{border:1px solid #cbd5e1;border-radius:10px;padding:6px 10px;background:#fff;color:var(--text);cursor:pointer}
    .pill{border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;background:var(--pill)}
    h3{margin:0 0 6px 0}
    b{font-size:16px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
    .modal.open{display:flex}
    .panel{width:min(1000px,100%);max-height:90vh;overflow:auto;background:var(--card);border-radius:16px;padding:16px;border:1px solid var(--border)}
    .hr{height:1px;background:var(--border);margin:12px 0}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .grow{flex:1}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>ICUè—¥ç‰©é€Ÿç‡è¨ˆç®—å™¨</h1>
        <div class="note"><b>å»ºè­°åŠ‘é‡Â·æ¿ƒåº¦åˆ‡æ›Â·é›™å‘æ›ç®—(åŠ‘é‡â†”é€Ÿç‡ï¼‰Â·å¯ç”¨æº¶æ¶²(D5W/NS)</b></div>
      </div>
      <div class="row">
        <button id="manage" class="btn">ç®¡ç†</button>
        <button id="share" class="btn">åˆ†äº«é€£çµ</button>
        <button id="refresh" class="btn">ğŸ”„ æ¸…å¿«å–</button>
      </div>
    </div>

    <div id="cards"></div>
    <div class="card"><div class="hint">è‡¨åºŠå®‰å…¨æé†’ï¼šæœ¬å·¥å…·åƒ…ä¾›æé†’ï¼›æœ€çµ‚ä»ä»¥é™¢å…§è™•æ–¹é›† / é†«å›‘ / SOP ç‚ºæº–ã€‚</div></div>
  </div>

  <!-- ç®¡ç†é¢æ¿ -->
  <div id="modal" class="modal">
    <div class="panel">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">è—¥ç‰©æ¸…å–®ç®¡ç†</h3>
        <div class="row">
          <button id="theme-toggle" class="btn">ğŸŒ™ æ·±è‰²æ¨¡å¼</button>
          <button id="export" class="btn">åŒ¯å‡º</button>
          <button id="import" class="btn">åŒ¯å…¥</button>
          <button id="close" class="btn">é—œé–‰</button>
        </div>
      </div>

      <div class="hint">æœ¬æ©Ÿå¿«å–ï¼ˆlocalStorage: <code>icu-drugs-v12</code>ï¼‰ã€‚å¯åœ¨æ­¤ï¼šæ–°å¢ã€ç·¨è¼¯ã€æ’åºï¼ˆä¸Šç§»/ä¸‹ç§»ï¼‰ã€‚</div>

      <div id="list" style="margin-top:10px"></div>

      <div class="hr"></div>
      <button id="add" class="btn">ï¼‹ æ–°å¢è—¥ç‰©</button>
    </div>
  </div>

  <script>
  // ===== ä¸»é¡Œï¼ˆæ·±/æ·ºï¼‰ =====
  const THEME_KEY = 'icu-theme-v2';
  const LIGHT = { bg:'#f8fafc', text:'#0f172a', card:'#ffffff', border:'#e5e7eb', muted:'#64748b', accent:'#0f172a', pill:'#f1f5f9' };
  const DARK  = { bg:'#0b1220', text:'#e6eefc', card:'#0f172a', border:'#1f2a44', muted:'#9fb0d0', accent:'#5da7ff', pill:'#17223a' };

  function applyTheme(t){
    const r = document.documentElement.style;
    Object.entries(t).forEach(([k,v])=>r.setProperty(`--${k}`, v));
  }
  function loadTheme(){ try{ return JSON.parse(localStorage.getItem(THEME_KEY)) || LIGHT; } catch{ return LIGHT; } }
  function saveTheme(t){ localStorage.setItem(THEME_KEY, JSON.stringify(t)); }

  let THEME = loadTheme(); applyTheme(THEME);

  // ===== è³‡æ–™ =====
  const KEY = 'icu-drugs-v12'; // å‡ç‰ˆæœ¬é¿å…èˆŠè³‡æ–™å¹²æ“¾
  const DEFAULT = [
    { key:"NE", name:"Norepinephrine (Levophed) æ­£è…ä¸Šè…ºç´ ", unit:"ug",
      concs:[{label:"8 mg / 250 mL (32 Î¼g/mL)", value:32},{label:"16 mg / 250 mL (64 Î¼g/mL)", value:64}],
      ref:{min:2, max:30, unit:"Î¼g/min", type:"nonwt"},
      diluents:["D5W"],
      notes:"16mgåƒ…é™æ–¼æœ‰CVCçš„ç—…æ‚£ï¼›ç„¡è«–æ¿ƒåº¦ï¼Œçš†é ˆåš´å¯†ç›£æ¸¬å¤–æ»²ã€‚"
    },
    { key:"Vaso", name:"Vasopressin (Pitressin) åŠ å£“ç´ ", unit:"unit",
      concs:[{label:"40 U / 100 mL (0.4 U/mL)", value:0.4}],
      ref:{min:0.01, max:0.04, unit:"U/min", type:"nonwt"},
      diluents:["NS","D5W"],
      notes:"å¸¸å›ºå®š 0.03â€“0.04 U/min ä½œç‚º NE ä½è—¥ï¼›ä¸å»ºè­°å†ä¸Šèª¿ã€‚"
    },
    { key:"Epi", name:"Epinephrine (Adrenalin) è…ä¸Šè…ºç´ ", unit:"ug",
      concs:[{label:"1 mg / 100 mL (10 Î¼g/mL)", value:10},{label:"5 mg / 250 mL (20 Î¼g/mL)", value:20}],
      ref:{min:2, max:10, unit:"Î¼g/min", type:"nonwt"},
      diluents:["NS"],
      notes:"é€šå¸¸æ–¼LevophedåŠVasopressinä½¿ç”¨å¾Œä»è¡€å£“ä¸ç©©æ–¹ä½¿ç”¨ï¼›å‘¨é‚Šåƒ…æš«ç”¨ï¼Œå„ªå…ˆ CVCã€‚"
    },
    { key:"Dopa", name:"Dopamine (Gipamine) å¤šå·´èƒº", unit:"ug",
      concs:[{label:"600 mg / 200 mL (3000 Î¼g/mL)", value:3000}],
      ref:{min:5, max:20, unit:"Î¼g/kg/min", type:"wt"},
      diluents:["D5W"],
      notes:"5â€“10 Î¼g/kg/min ä»¥ Î² æ•ˆæ‡‰ç‚ºä¸»ï¼›10â€“20 Î¼g/kg/min Î± æ•ˆæ‡‰å¢åŠ ã€‚"
    },
    { key:"Dobu", name:"Dobutamine (GENDOBU) å¤šå·´é…šä¸èƒº", unit:"ug",
      concs:[{label:"250 mg / 250 mL (1000 Î¼g/mL)", value:1000},{label:"500 mg / 250 mL (2000 Î¼g/mL)", value:2000}],
      ref:{min:2, max:20, unit:"Î¼g/kg/min", type:"wt"},
      diluents:["NS","D5W"],
      notes:"2â€“20 Î¼g/kg/min å¸¸ç”¨ï¼›ç•™æ„å¿ƒæéé€Ÿèˆ‡è¡€å£“ã€‚"
    },
    { key:"Lido", name:"Lidocaine (Xylocaine) åˆ©å¤šå¡å› ", unit:"mg",
      concs:[{label:"1 g / 500 mL (2 mg/mL)", value:2},{label:"2 g / 500 mL (4 mg/mL)", value:4}],
      ref:{min:1, max:4, unit:"mg/min", type:"nonwt"},
      diluents:["NS","D5W"],
      notes:"æŠ—å¿ƒå¾‹ä¸æ•´ç¶­æŒ 1â€“4 mg/minï¼›è‚è…åŠŸèƒ½ä¸å…¨é…Œé™ã€‚"
    },
    { key:"Nica", name:"Nicardipine (Perdipine) å°¼å¡åœ°å¹³", unit:"mg",
      concs:[{label:"5 amp in 200 mL â†’ 50 mg / 250 mL (0.2 mg/mL)", value:0.2}],
      ref:{min:3, max:15, unit:"mg/hr", type:"nonwt"},
      diluents:["NS"],
      notes:"3â€“15 mg/hrï¼›5 mg/hr èµ·ï¼Œæ¯ 5â€“15 åˆ†é˜åŠ  2.5 mg/hrï¼Œæœ€å¤§ 15 mg/hrã€‚"
    },
    { key:"NTG", name:"Nitroglycerin (Millistrol) ç¡é…¸ç”˜æ²¹", unit:"ug",
      concs:[
        {label:"5 amp in 200 mL â†’ 250 mg / 250 mL (1000 Î¼g/mL)", value:1000},
        {label:"10 amp in 150 mL â†’ 500 mg / 250 mL (2000 Î¼g/mL)", value:2000}
      ],
      ref:{min:5, max:200, unit:"Î¼g/min", type:"nonwt"},
      diluents:["NS","D5W"],
      notes:"èµ·å§‹ 5 Î¼g/min é€æ­¥ä¸Šèª¿ï¼›ä½¿ç”¨ç»ç’ƒç“¶/éå¸é™„ç®¡è·¯ã€‚"
    },
  ];

  const $ = s => document.querySelector(s);
  const fmt = n => Number.isFinite(n)?(+n).toFixed(2).replace(/\.?0+$/,''):"";
  let model = load(); render();

  function load(){ try{ const x = JSON.parse(localStorage.getItem(KEY)); return Array.isArray(x)&&x.length?x:DEFAULT; } catch{ return DEFAULT } }
  function save(){ localStorage.setItem(KEY, JSON.stringify(model)); }

  // ===== è¨ˆç®—å·¥å…· =====
  function baseUnitSymbol(drug){ if (drug.unit==='ug') return 'Î¼g'; if (drug.unit==='mg') return 'mg'; if (drug.unit==='unit') return 'U'; return ''; }
  function timeFactor(d){
    const u = (d.ref?.unit || "").toLowerCase().replace(/\s+/g,'');
    if (u.includes('/min')) return 60;
    if (u.includes('/hr')) return 1;
    console.warn('æœªåµæ¸¬åˆ° /min æˆ– /hrï¼Œé è¨­æŒ‰ /minï¼š', d.ref?.unit);
    return 60;
  }
  function doseDisplayUnit(d){
    if (d.ref && d.ref.unit) return d.ref.unit;
    const b = baseUnitSymbol(d);
    return d.ref?.type === 'wt' ? `${b}/kg/min` : `${b}/min`;
  }
  function suggestRateText(d, conc, wt){
    if (!conc) return "";
    const {min, max, type} = d.ref;
    const tf = timeFactor(d);
    if (type==='wt'){
      if (!(wt>0)) return "è«‹å…ˆè¼¸å…¥é«”é‡";
      const rMin = (min * wt * tf) / conc;
      const rMax = (max * wt * tf) / conc;
      return `${fmt(rMin)}â€“${fmt(rMax)} mL/hr`;
    } else {
      const rMin = (min * tf) / conc;
      const rMax = (max * tf) / conc;
      return `${fmt(rMin)}â€“${fmt(rMax)} mL/hr`;
    }
  }

  // ===== UIï¼šè—¥å¡ï¼ˆé›™å‘æ›ç®—ï¼‰ =====
  function makeCard(d){
    const card = document.createElement('div'); card.className='card';
    const title = document.createElement('h3'); title.textContent = d.name; card.appendChild(title);

    // å¯ç”¨æº¶æ¶²
    const dil = document.createElement('div'); dil.className='chips';
    const label = document.createElement('div'); label.className='hint'; label.textContent = 'å¯ç”¨æº¶æ¶²ï¼š';
    dil.appendChild(label);
    (d.diluents||[]).forEach(x=>{ const t=document.createElement('span'); t.className='pill'; t.textContent=x; dil.appendChild(t); });
    card.appendChild(dil);

    // å»ºè­°åŠ‘é‡
    const suggest = document.createElement('div');
    suggest.innerHTML = `<b>å»ºè­°åŠ‘é‡ï¼š</b>${d.ref.min}â€“${d.ref.max} ${d.ref.unit}ï¼ˆæˆäººï¼‰`;
    card.appendChild(suggest);

    // æ¿ƒåº¦é¸æ“‡
    const sel = document.createElement('select'); sel.className='select';
    d.concs.forEach(c=>{ const o=document.createElement('option'); o.value=c.value; o.textContent=c.label; sel.appendChild(o); });
    card.append("æ¿ƒåº¦ï¼š", sel);

    // å»ºè­°é€Ÿç‡ï¼ˆåŒæ­¥ï¼‰
    const sugg = document.createElement('div'); sugg.className='note'; card.appendChild(sugg);

    // è¨ˆç®—å€ï¼ˆé›™å‘ï¼‰
    const box = document.createElement('div'); box.className='card'; box.style.padding='12px'; box.style.marginTop='10px';

    const doseRow = document.createElement('div'); doseRow.className='row';
    const rateRow = document.createElement('div'); rateRow.className='row';

    const dInp = document.createElement('input'); dInp.className='input grow'; dInp.inputMode='decimal';
    dInp.placeholder = `${d.ref.min}â€“${d.ref.max}`;
    const dUnit = document.createElement('span');

    const rInp = document.createElement('input'); rInp.className='input grow'; rInp.inputMode='decimal'; rInp.placeholder='mL/hr';
    const rUnit = document.createElement('span'); rUnit.textContent='mL/hr';

    let lastEdited = null; // 'dose' | 'rate'

    if (d.ref.type === 'wt'){
      // é«”é‡å‹
      const wRow = document.createElement('div'); wRow.className='row';
      const wLab = document.createElement('span'); wLab.textContent='é«”é‡';
      const wIn = document.createElement('input'); wIn.className='input'; wIn.style.width='90px'; wIn.placeholder='60'; wIn.inputMode='decimal';
      const wU = document.createElement('span'); wU.textContent='kg';
      wRow.append(wLab, wIn, wU);
      box.appendChild(wRow);

      dUnit.textContent = doseDisplayUnit(d);
      doseRow.append(dInp, dUnit);
      rateRow.append(rInp, rUnit);
      box.appendChild(doseRow);
      box.appendChild(rateRow);

      const updateSuggest = ()=>{
        const conc = parseFloat(sel.value);
        const wt = parseFloat(wIn.value)||0;
        sugg.textContent = `â‰ˆ å»ºè­°é€Ÿç‡ï¼š${suggestRateText(d, conc, wt)}`;
      };

      const sync = ()=>{
        const conc = parseFloat(sel.value);
        const wt = parseFloat(wIn.value)||0;
        const tf = timeFactor(d);
        if (!(conc>0)) return;
        if (lastEdited==='dose'){
          const dose = parseFloat(dInp.value);
          if (Number.isFinite(dose) && wt>0) rInp.value = fmt(dose*wt*tf/conc);
          else if (!wt) rInp.value = '';
        } else if (lastEdited==='rate'){
          const rate = parseFloat(rInp.value);
          if (Number.isFinite(rate) && wt>0) dInp.value = fmt(rate*conc/(tf*wt));
          else if (!wt) dInp.value = '';
        }
      };

      [sel, wIn].forEach(x=>x.addEventListener('input', ()=>{ updateSuggest(); sync(); }));
      dInp.addEventListener('input', ()=>{ lastEdited='dose'; sync(); });
      rInp.addEventListener('input', ()=>{ lastEdited='rate'; sync(); });

      updateSuggest();
    } else {
      // éé«”é‡å‹
      dUnit.textContent = doseDisplayUnit(d);
      doseRow.append(dInp, dUnit);
      rateRow.append(rInp, rUnit);
      box.appendChild(doseRow);
      box.appendChild(rateRow);

      const updateSuggest = ()=>{
        const conc = parseFloat(sel.value);
        sugg.textContent = `â‰ˆ å»ºè­°é€Ÿç‡ï¼š${suggestRateText(d, conc, 0)}`;
      };

      const sync = ()=>{
        const conc = parseFloat(sel.value);
        const tf = timeFactor(d);
        if (!(conc>0)) return;
        if (lastEdited==='dose'){
          const dose = parseFloat(dInp.value);
          if (Number.isFinite(dose)) rInp.value = fmt(dose*tf/conc);
        } else if (lastEdited==='rate'){
          const rate = parseFloat(rInp.value);
          if (Number.isFinite(rate)) dInp.value = fmt(rate*conc/tf);
        }
      };

      sel.addEventListener('input', ()=>{ updateSuggest(); sync(); });
      dInp.addEventListener('input', ()=>{ lastEdited='dose'; sync(); });
      rInp.addEventListener('input', ()=>{ lastEdited='rate'; sync(); });

      updateSuggest();
    }

    // å…¬å¼æç¤º
    const formula = document.createElement('div'); formula.className='hint';
    const tfTxt = timeFactor(d);
    formula.textContent = (d.ref.type==='wt')
      ? `${doseDisplayUnit(d)} â†” mL/hrï¼ˆmL/hr = åŠ‘é‡ Ã— é«”é‡ Ã— ${tfTxt} Ã· æ¿ƒåº¦ï¼›åŠ‘é‡ = mL/hr Ã— æ¿ƒåº¦ Ã· (${tfTxt} Ã— é«”é‡)ï¼‰`
      : `${doseDisplayUnit(d)} â†” mL/hrï¼ˆmL/hr = åŠ‘é‡ Ã— ${tfTxt} Ã· æ¿ƒåº¦ï¼›åŠ‘é‡ = mL/hr Ã— æ¿ƒåº¦ Ã· ${tfTxt}ï¼‰`;
    box.appendChild(formula);

    card.appendChild(box);

    // å‚™è¨»
    const note = document.createElement('div'); note.className='hint'; note.textContent = d.notes || '';
    card.appendChild(note);

    return card;
  }

  function render(){ const box = $('#cards'); box.innerHTML=''; model.forEach(d => box.appendChild(makeCard(d))); }

  // ===== ç®¡ç†ï¼šåˆ—è¡¨ + æ’åº + ç·¨è¼¯ + æ–°å¢ =====
  function renderList(){
    const L = document.getElementById('list'); if (!L) return;
    L.innerHTML='';
    model.forEach((d,i)=>{
      const row = document.createElement('div'); row.className='card';
      row.innerHTML = `<b>${d.name}</b> <span class="hint">(${d.key})</span><br>
        <span class="hint">æ¿ƒåº¦ï¼š${d.concs.map(x=>x.label).join('ã€')}</span><br>
        <span class="hint">å¯ç”¨æº¶æ¶²ï¼š${(d.diluents||[]).join('ã€')||'â€”'}</span><br>
        <span class="hint">å»ºè­°åŠ‘é‡å–®ä½ï¼š${d.ref.unit}</span>`;

      const btnRow = document.createElement('div'); btnRow.className='row'; btnRow.style.marginTop='8px';

      const btnUp   = document.createElement('button'); btnUp.className='btn-ghost'; btnUp.textContent='â¬† ä¸Šç§»';
      const btnDown = document.createElement('button'); btnDown.className='btn-ghost'; btnDown.textContent='â¬‡ ä¸‹ç§»';
      const btnE    = document.createElement('button'); btnE.className='btn-ghost'; btnE.textContent='ç·¨è¼¯';
      const btnD    = document.createElement('button'); btnD.className='btn-ghost'; btnD.textContent='åˆªé™¤';

      btnUp.onclick   = ()=> moveDrug(i, -1);
      btnDown.onclick = ()=> moveDrug(i, +1);
      btnE.onclick    = ()=> editDrug(i);
      btnD.onclick    = ()=> { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')){ model.splice(i,1); save(); renderList(); render(); } };

      if (i===0) btnUp.disabled = true;
      if (i===model.length-1) btnDown.disabled = true;

      btnRow.append(btnUp, btnDown, btnE, btnD);
      row.append(btnRow);
      L.appendChild(row);
    });

    // åŒæ­¥æ·±/æ·ºè‰²æŒ‰éˆ•æ–‡å­—
    const themeBtn = document.getElementById('theme-toggle');
    if (themeBtn){
      const isDark = JSON.stringify(THEME) === JSON.stringify(DARK);
      themeBtn.textContent = isDark ? 'â˜€ï¸ æ·ºè‰²æ¨¡å¼' : 'ğŸŒ™ æ·±è‰²æ¨¡å¼';
    }
  }

  function moveDrug(index, delta){
    const j = index + delta;
    if (j < 0 || j >= model.length) return;
    const tmp = model[index]; model[index] = model[j]; model[j] = tmp;
    save(); renderList(); render();
  }

  function field(label, el){
    const wrap = document.createElement('label'); wrap.style.display='block'; wrap.style.margin='6px 0';
    const cap = document.createElement('div'); cap.className='hint'; cap.textContent = label;
    wrap.append(cap, el); return wrap;
  }

  function editDrug(i){
    const d = JSON.parse(JSON.stringify(model[i])); // clone
    const box = document.getElementById('list'); if (!box) return; box.innerHTML='';

    const key = document.createElement('input'); key.className='input'; key.value=d.key;
    const name = document.createElement('input'); name.className='input'; name.value=d.name;

    const unit = document.createElement('select'); unit.className='select';
    [['ug','å¾®å…‹ Î¼g'],['mg','æ¯«å…‹ mg'],['unit','å–®ä½ U']].forEach(([v,t])=>{ const o=document.createElement('option'); o.value=v; o.textContent=t; unit.appendChild(o); });
    unit.value = d.unit;

    const type = document.createElement('select'); type.className='select';
    [['wt','é«”é‡å‹ï¼ˆ*/kg/min æˆ– */kg/hrï¼‰'],['nonwt','éé«”é‡å‹ï¼ˆ*/min æˆ– */hrï¼‰']].forEach(([v,t])=>{ const o=document.createElement('option'); o.value=v; o.textContent=t; type.appendChild(o); });
    type.value = d.ref.type;

    const rmin = document.createElement('input'); rmin.className='input'; rmin.inputMode='decimal'; rmin.value=d.ref.min;
    const rmax = document.createElement('input'); rmax.className='input'; rmax.inputMode='decimal'; rmax.value=d.ref.max;

    const refUnits = [
      'Î¼g/min','mg/min','U/min',
      'Î¼g/kg/min','mg/kg/min','U/kg/min',
      'Î¼g/hr','mg/hr','U/hr',
      'Î¼g/kg/hr','mg/kg/hr','U/kg/hr'
    ];
    const runit = document.createElement('select'); runit.className='select';
    refUnits.forEach(u=>{ const o=document.createElement('option'); o.value=u; o.textContent=u; runit.appendChild(o); });
    const norm = s => (s||'').toLowerCase().replace(/\s+/g,'');
    const found = refUnits.find(u => norm(u) === norm(d.ref.unit));
    runit.value = found || 'Î¼g/min';

    const notes = document.createElement('textarea'); notes.className='input'; notes.value=d.notes||''; notes.rows=3;

    // å¯ç”¨æº¶æ¶²å‹¾é¸
    const dilWrap = document.createElement('div');
    const cbNS = document.createElement('input'); cbNS.type='checkbox';
    const labNS = document.createElement('span'); labNS.textContent='NS';
    const cbD5 = document.createElement('input'); cbD5.type='checkbox';
    const labD5 = document.createElement('span'); labD5.textContent='D5W';
    cbNS.checked = (d.diluents||[]).includes('NS');
    cbD5.checked = (d.diluents||[]).includes('D5W');
    const dilRow = document.createElement('div'); dilRow.className='row';
    dilRow.append(cbNS, labNS, cbD5, labD5);
    dilWrap.appendChild(dilRow);

    // æ¿ƒåº¦æ¸…å–®
    const concWrap = document.createElement('div');
    const concList = document.createElement('div'); concWrap.appendChild(concList);
    const addConcBtn = document.createElement('button'); addConcBtn.className='btn-ghost'; addConcBtn.textContent='ï¼‹ æ–°å¢æ¿ƒåº¦';
    addConcBtn.onclick = ()=>{ d.concs.push({label:'',value:0}); drawConcs(); };
    concWrap.appendChild(addConcBtn);

    function drawConcs(){
      concList.innerHTML='';
      d.concs.forEach((c,ci)=>{
        const row=document.createElement('div'); row.className='row';
        const l=document.createElement('input'); l.className='input grow'; l.placeholder='ä¾‹ï¼š50 mg / 250 mL (0.2 mg/mL)'; l.value=c.label;
        const v=document.createElement('input'); v.className='input'; v.style.width='160px'; v.inputMode='decimal'; v.placeholder='æ¯ mL æ•¸å€¼ï¼ˆ0.2ã€1000â€¦ï¼‰'; v.value=c.value;
        const del=document.createElement('button'); del.className='btn-ghost'; del.textContent='åˆªé™¤';
        l.oninput=()=>c.label=l.value; v.oninput=()=>c.value=+v.value; del.onclick=()=>{ d.concs.splice(ci,1); drawConcs(); };
        row.append(l,v,del); concList.appendChild(row);
      });
    }
    drawConcs();

    const saveBtn = document.createElement('button'); saveBtn.className='btn'; saveBtn.textContent='å„²å­˜';
    saveBtn.onclick = ()=>{
      d.key = key.value.trim(); d.name = name.value.trim();
      d.unit = unit.value; d.ref.type = type.value;
      d.ref.min = +rmin.value; d.ref.max = +rmax.value; d.ref.unit = runit.value;
      d.diluents = []; if (cbNS.checked) d.diluents.push('NS'); if (cbD5.checked) d.diluents.push('D5W');
      d.concs = d.concs.filter(x=>x.label && Number.isFinite(+x.value) && +x.value>0).map(x=>({label:x.label, value:+x.value}));
      d.notes = notes.value;
      if (!d.key || !d.name) return alert('key èˆ‡ name å¿…å¡«');
      if (d.concs.length===0) return alert('è‡³å°‘ä¸€ç­†æ¿ƒåº¦');
      model[i] = d; save(); renderList(); render(); alert('å·²å„²å­˜');
    };

    const backBtn = document.createElement('button'); backBtn.className='btn-ghost'; backBtn.textContent='è¿”å›';
    backBtn.onclick = ()=> renderList();

    box.append(
      field('keyï¼ˆè‹±æ•¸ï¼Œä¸é‡è¤‡ï¼‰', key),
      field('åç¨±', name),
      field('æ¿ƒåº¦åŸºæœ¬å–®ä½ï¼ˆæ±ºå®š concs.value çš„å–®ä½ / mLï¼‰', unit),
      field('åŠ‘é‡å‹æ…‹ï¼ˆé«”é‡å‹ / éé«”é‡å‹ï¼‰', type),
      field('å»ºè­°åŠ‘é‡æœ€å°å€¼', rmin),
      field('å»ºè­°åŠ‘é‡æœ€å¤§å€¼', rmax),
      field('å»ºè­°åŠ‘é‡å–®ä½ï¼ˆé¸æ“‡ /min æˆ– /hrã€æ˜¯å¦å« /kgï¼‰', runit),
      field('å¯ç”¨æº¶æ¶²ï¼ˆå‹¾é¸ï¼‰', dilWrap),
      field('æ¿ƒåº¦æ¸…å–®ï¼ˆvalue ä»¥ä¸Šè¿°åŸºæœ¬å–®ä½ / mLï¼‰', concWrap),
      field('å‚™è¨»', notes),
      document.createElement('div'),
      saveBtn, backBtn
    );
  }

  function addDrug(){
    model.push({
      key:'Drug'+(Date.now()%10000), name:'æ–°è—¥', unit:'ug',
      concs:[{label:'1 mg / 100 mL (10 Î¼g/mL)', value:10}],
      ref:{min:1, max:10, unit:'Î¼g/kg/min', type:'wt'},
      diluents:['NS','D5W'],
      notes:''
    });
    save(); renderList(); render();
  }

  // ===== ç®¡ç†é¢æ¿æŒ‰éˆ•ç¶å®š =====
  document.getElementById('manage').onclick = ()=>{
    document.getElementById('modal').classList.add('open');
    renderList();
  };
  document.getElementById('close').onclick = ()=>{ document.getElementById('modal').classList.remove('open'); };
  document.getElementById('add').onclick = addDrug;

  // ä¸»é¡Œåˆ‡æ›æŒ‰éˆ•
  document.getElementById('theme-toggle').onclick = ()=>{
    const isDark = JSON.stringify(THEME) === JSON.stringify(DARK);
    THEME = isDark ? LIGHT : DARK;
    applyTheme(THEME); saveTheme(THEME);
    document.getElementById('theme-toggle').textContent = isDark ? 'ğŸŒ™ æ·±è‰²æ¨¡å¼' : 'â˜€ï¸ æ·ºè‰²æ¨¡å¼';
  };

  // åŒ¯å‡º / åŒ¯å…¥
  document.getElementById('export').onclick = ()=>{
    const blob = new Blob([JSON.stringify(model,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='icu-drugs-export.json'; a.click();
    URL.revokeObjectURL(url);
  };
  document.getElementById('import').onclick = ()=>{
    const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange = ()=>{ const f=inp.files[0]; if(!f) return;
      f.text().then(t=>{
        try{ const arr=JSON.parse(t); if(!Array.isArray(arr)) throw 0; model=arr; save(); renderList(); render(); alert('åŒ¯å…¥å®Œæˆ'); }
        catch{ alert('æ ¼å¼éŒ¯èª¤ï¼šéœ€è¦ Array JSON'); }
      });
    };
    inp.click();
  };

  // ===== ä¸€éµåˆ†äº«é€£çµï¼ˆå…é›²ç«¯ï¼‰ =====
  document.getElementById('share').addEventListener('click', async ()=>{
    try{
      const payload = encodeURIComponent(JSON.stringify(model));
      const b64 = btoa(payload);
      const longUrl = `${location.origin}${location.pathname}#d=${b64}`;
      // TinyURL çŸ­å€ï¼ˆå¤±æ•—å°±ç”¨åŸå€ï¼‰
      const apiUrl = `https://tinyurl.com/api-create.php?url=${encodeURIComponent(longUrl)}`;
      const shortUrl = await fetch(apiUrl).then(r => r.text()).catch(()=> longUrl);
      await navigator.clipboard?.writeText(shortUrl);
      alert(`âœ… å·²ç”¢ç”ŸçŸ­ç¶²å€ä¸¦è¤‡è£½ï¼š\n${shortUrl}`);
    }catch(e){
      alert('âŒ ç”¢ç”Ÿåˆ†äº«é€£çµå¤±æ•—ï¼ˆå¯èƒ½æ˜¯è³‡æ–™å¤ªå¤§æˆ–ç¶²è·¯å•é¡Œï¼‰');
    }
  });

  // è‹¥ä»¥ #d= é–‹å•Ÿ â†’ è‡ªå‹•åŒ¯å…¥ä¸¦æ¸…æ‰ hash
  (function(){
    if (location.hash.startsWith('#d=')) {
      try{
        const b64 = location.hash.slice(3);
        const json = decodeURIComponent(atob(b64));
        const data = JSON.parse(json);
        if (Array.isArray(data) && data.length) {
          model = data; save(); renderList(); render();
          alert('å·²å¾é€£çµè¼‰å…¥è—¥ç‰©æ¸…å–®ï¼Œä¸¦å„²å­˜åœ¨æ­¤è£ç½®ã€‚');
        }
      }catch(e){ console.warn('åˆ†äº«é€£çµè§£æå¤±æ•—', e); }
      history.replaceState(null, '', location.pathname + location.search);
    }
  })();

  // âœ… åªå‘¼å«ï¼Œä¸è¦å†è¦†è“‹ renderListï¼
  renderList();

  // ===== PWAï¼šService Worker è¨»å†Š + ä¸€éµæ¸…å¿«å– =====
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }
  document.getElementById('refresh').addEventListener('click', async ()=>{
    try{
      if ('caches' in window){ const keys = await caches.keys(); for (let k of keys) await caches.delete(k); }
      if (navigator.serviceWorker){ const regs = await navigator.serviceWorker.getRegistrations(); for (let r of regs) await r.unregister(); }
    } finally { location.reload(true); }
  });
  </script>
</body>
</html>
