<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ICU æ€¥æ•‘è—¥ç‰©é€Ÿç‡è¨ˆç®—å™¨</title>
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#0f172a" />
  <style>
    body{font-family:system-ui,sans-serif;background:#f8fafc;color:#0f172a;margin:0}
    .wrap{max-width:1000px;margin:24px auto;padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 4px 16px rgba(0,0,0,.06)}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .input,.select{border:1px solid #cbd5e1;border-radius:10px;padding:8px 10px;font-size:14px}
    .note{font-size:14px;color:#0f172a}
    .btn-refresh{border:1px solid #0f172a;border-radius:10px;padding:6px 10px;background:#0f172a;color:#fff;font-size:12px;cursor:pointer;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>ICU æ€¥æ•‘è—¥ç‰©é€Ÿç‡è¨ˆç®—å™¨</h1>
        <div class="note">PWA Â· å¯é›¢ç·š Â· å»ºè­°åŠ‘é‡åŒæ­¥æ›ç®— mL/hr</div>
      </div>
      <div class="row">
        <span>é«”é‡</span>
        <input id="weight" class="input" style="width:90px" inputmode="decimal" placeholder="60">
        <span>kg</span>
        <button id="refresh" class="btn-refresh">ğŸ”„ å¼·åˆ¶åˆ·æ–°</button>
      </div>
    </div>
    <div id="cards"></div>
  </div>

  <script>
  // ---- è—¥ç‰©è³‡æ–™ï¼ˆå«è‡¨åºŠå»ºè­°åŠ‘é‡ + å¯é¸æ¿ƒåº¦ï¼‰ ----
  const DRUGS = [
    { key:"Epi", name:"Epinephrine è…ä¸Šè…ºç´ ", unit:"ug",
      concs:[{label:"1 mg / 100 mL (10 Î¼g/mL)",value:10},{label:"5 mg / 250 mL (20 Î¼g/mL)",value:20}],
      ref:{min:2, max:10, unit:"Î¼g/min", type:"nonwt"},
      notes:"ACLS/ä¼‘å…‹æ”¯æ´ï¼›å‘¨é‚Šåƒ…æš«ç”¨ï¼Œå„ªå…ˆ CVCã€‚"
    },
    { key:"NE", name:"Norepinephrine (Levophed) æ­£è…ä¸Šè…ºç´ ", unit:"ug",
      concs:[{label:"8 mg / 250 mL (32 Î¼g/mL)",value:32},{label:"16 mg / 250 mL (64 Î¼g/mL)",value:64}],
      ref:{min:2, max:30, unit:"Î¼g/min", type:"nonwt"},
      notes:"æ•—è¡€æ€§ä¼‘å…‹é¦–é¸ï¼›åš´é˜²å¤–æ»²ï¼Œæœ«æ¢¢ç›£æ¸¬ã€‚"
    },
    { key:"Dopa", name:"Dopamine å¤šå·´èƒº", unit:"ug",
      concs:[{label:"600 mg / 200 mL (3000 Î¼g/mL)",value:3000}],
      ref:{min:5, max:20, unit:"Î¼g/kg/min", type:"wt"},
      notes:"ä¸­é«˜åŠ‘é‡å…·æœ‰ Î± æ•ˆæ‡‰ï¼Œéœ€ç›£æ§ã€‚"
    },
    { key:"Dobu", name:"Dobutamine å¤šå·´é…šä¸èƒº", unit:"ug",
      concs:[{label:"250 mg / 250 mL (1000 Î¼g/mL)",value:1000}],
      ref:{min:2, max:20, unit:"Î¼g/kg/min", type:"wt"},
      notes:"ä½å¿ƒè¼¸å‡ºæ€§å¿ƒè¡°ç”¨è—¥ã€‚"
    },
    { key:"Vaso", name:"Vasopressin åŠ å£“ç´ ", unit:"unit",
      concs:[{label:"40 U / 100 mL (0.4 U/mL)",value:0.4}],
      ref:{min:0.01, max:0.04, unit:"U/min", type:"nonwt"},
      notes:"å¤šæ¡å›ºå®šåŠ‘é‡ï¼›ä¸å»ºè­°æ»´å®š >0.04 U/minã€‚"
    }
  ];

  const $ = s => document.querySelector(s);
  const fmt = n => Number.isFinite(n)?(+n).toFixed(2).replace(/\.?0+$/,''):"";

  // ä¾å»ºè­°åŠ‘é‡ç¯„åœèˆ‡æ¿ƒåº¦ï¼ˆåŠé«”é‡ï¼‰è¨ˆç®—å»ºè­°é€Ÿç‡ mL/hr
  function calcRange(drug, conc, wt){
    if (!conc) return "";
    const {min, max, type} = drug.ref;
    let rMin, rMax;
    if (type === "wt" && wt > 0) {
      rMin = min * wt * 60 / conc;
      rMax = max * wt * 60 / conc;
    } else {
      rMin = min * 60 / conc;
      rMax = max * 60 / conc;
    }
    return `${fmt(rMin)}â€“${fmt(rMax)} mL/hr`;
  }

  function render(){
    const box = $("#cards"); box.innerHTML = "";
    const wt = parseFloat($("#weight").value) || 0;

    DRUGS.forEach(d => {
      const card = document.createElement("div"); card.className = "card";

      // âœ… è£œä¸Šè—¥åæ¨™é¡Œ
      const title = document.createElement("h3");
      title.textContent = d.name;
      card.appendChild(title);

      // å»ºè­°åŠ‘é‡
      const suggest = document.createElement("div");
      suggest.innerHTML = `<b>å»ºè­°åŠ‘é‡ï¼š</b>${d.ref.min}â€“${d.ref.max} ${d.ref.unit}ï¼ˆæˆäººï¼‰`;
      card.appendChild(suggest);

      // æ¿ƒåº¦ä¸‹æ‹‰
      const sel = document.createElement("select"); sel.className = "select";
      d.concs.forEach(c => {
        const o = document.createElement("option");
        o.value = c.value; o.textContent = c.label;
        sel.appendChild(o);
      });
      card.append("æ¿ƒåº¦ï¼š", sel);
      card.appendChild(document.createElement("br"));

      // å»ºè­°é€Ÿç‡ï¼ˆæœƒéš¨é«”é‡/æ¿ƒåº¦è®Šå‹•ï¼‰
      const rateLine = document.createElement("div");
      rateLine.className = "note";
      const upd = () => {
        rateLine.textContent = `â‰ˆ å»ºè­°é€Ÿç‡ï¼š${calcRange(d, parseFloat(sel.value), wt)}`;
      };
      sel.onchange = upd;
      $("#weight").oninput = upd;
      card.appendChild(rateLine);

      // å‚™è¨»
      const note = document.createElement("div");
      note.className = "note";
      note.textContent = d.notes;
      card.appendChild(document.createElement("br"));
      card.appendChild(note);

      // åˆæ¬¡æ›´æ–°
      upd();
      box.appendChild(card);
    });
  }

  render();

  // PWA Service Worker è¨»å†Š
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }

  // ğŸ”„ å¼·åˆ¶åˆ·æ–°ï¼šæ¸…é™¤ caches + è§£é™¤è¨»å†Š SW + é‡æ–°è¼‰å…¥
  document.getElementById('refresh').addEventListener('click', async () => {
    try{
      if ('caches' in window) {
        const keys = await caches.keys();
        for (let k of keys) await caches.delete(k);
      }
      if (navigator.serviceWorker) {
        const regs = await navigator.serviceWorker.getRegistrations();
        for (let r of regs) await r.unregister();
      }
    } finally {
      location.reload(true);
    }
  });
  </script>
</body>
</html>
