<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ICU 急救藥物速率計算器</title>

  <!-- PWA 支援 -->
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#0f172a" />

  <style>
    body { font-family: system-ui, sans-serif; background: #f8fafc; color: #0f172a; margin: 0; }
    .wrap { max-width: 960px; margin: 24px auto; padding: 16px; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 16px; padding: 16px; margin: 12px 0; box-shadow: 0 4px 16px rgba(0,0,0,.06); }
    .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
    .input, .select { border: 1px solid #cbd5e1; border-radius: 10px; padding: 8px 10px; font-size: 14px; }
    .btn { border: 1px solid #0f172a; border-radius: 10px; padding: 6px 10px; background: #0f172a; color: #fff; font-size: 12px; cursor: pointer; }
    .pill { border: 1px solid #e5e7eb; border-radius: 999px; padding: 4px 10px; font-size: 12px; background: #f1f5f9; }
    .note { font-size: 12px; color: #64748b; }
    .warn { border-color: #ef4444; background: #fee2e2; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>ICU 急救藥物速率計算器</h1>
        <div class="note">PWA · 離線可用 · 雙單位 · 自訂院內濃度</div>
      </div>
      <div class="row">
        <span>體重</span>
        <input id="weight" class="input" style="width:90px" inputmode="decimal" placeholder="60">
        <span>kg</span>
      </div>
    </div>

    <div id="cards"></div>

    <div class="card">
      <div class="note">
        臨床安全提醒：本工具僅供教學與提醒；實務以院內處方集 / 醫囑 / SOP 為準。
        升壓劑屬血管刺激性（vesicant），優先中心靜脈；周邊僅短暫應急並嚴密觀察外滲。
      </div>
    </div>
  </div>

  <script>
    const DRUGS = [
      {
        key: "Epi", name: "Epinephrine 腎上腺素", unit: "ug",
        concs: [{label:"1 mg / 100 mL (10 μg/mL)",value:10},{label:"5 mg / 250 mL (20 μg/mL)",value:20}],
        ref:{type:"nonwt",min:2,max:10,unit:"μg/min"},
        compat:{line:"CVC 優先（PIV 可短暫）",exclusive:true,lightProtect:false,coadmin:["NS","D5W"],avoid:["鹼性藥"],note:"外滲風險，監測末梢灌流"},
        notes:"ACLS 休克輔助。"
      },
      {
        key:"NE", name:"Norepinephrine (Levophed) 正腎上腺素", unit:"ug",
        concs:[{label:"8 mg / 250 mL (32 μg/mL)",value:32},{label:"16 mg / 250 mL (64 μg/mL)",value:64}],
        ref:{type:"wt",min:0.05,max:1.0,unit:"μg/kg/min"},
        compat:{line:"CVC 建議，PIV 僅暫用",exclusive:true,lightProtect:false,coadmin:["NS","D5W"],avoid:["血製劑"],note:"嚴防外滲，末梢監測"},
        notes:"敗血性休克首選升壓劑。"
      },
      {
        key:"Vaso", name:"Vasopressin 加壓素", unit:"unit",
        concs:[{label:"40 U / 100 mL (0.4 U/mL)",value:0.4}],
        ref:{type:"nonwt",min:0.01,max:0.04,unit:"U/min"},
        compat:{line:"CVC",exclusive:true,lightProtect:false,coadmin:["NS","D5W"],avoid:["多數藥"],note:"勿滴定 >0.04 U/min；外滲風險"},
        notes:"NE 佐藥，不建議滴定超標。"
      },
    ];

    const $ = s => document.querySelector(s);
    const fmt = n => Number.isFinite(n)?(+n).toFixed(3).replace(/\.?0+$/,''):"";

    function makeCard(d){
      const el=document.createElement('div');el.className='card';
      el.innerHTML=`
        <h3>${d.name}</h3>
        <div class="row">
          <span class="note">濃度</span>
          <select class="select js-conc"></select>
          <span class="note">參考：${d.ref.min}–${d.ref.max} ${d.ref.unit}</span>
        </div>
        <div class="row" style="margin-top:8px">
          <input class="input js-dose" placeholder="輸入劑量" inputmode="decimal">
          <button class="btn js-calc">計算</button>
          <span class="note">速率（mL/hr）：</span><b class="js-rate"></b>
        </div>
        <div class="note" style="margin-top:8px">相容性：${d.compat.line} ${d.compat.note}</div>`;
      const sel=el.querySelector('.js-conc');
      d.concs.forEach(c=>{const o=document.createElement('option');o.value=c.value;o.textContent=c.label;sel.appendChild(o)});
      const dose=el.querySelector('.js-dose'),rate=el.querySelector('.js-rate');
      el.querySelector('.js-calc').onclick=()=>{
        const conc=parseFloat(sel.value),v=parseFloat(dose.value),wt=parseFloat($('#weight').value);
        let r;
        if(d.ref.type==="wt"&&wt>0)r=v*wt*60/conc;
        else r=v*60/conc;
        rate.textContent=fmt(r);
      };
      return el;
    }

    DRUGS.forEach(d=>$('#cards').appendChild(makeCard(d)));

    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    }
  </script>
</body>
</html>
